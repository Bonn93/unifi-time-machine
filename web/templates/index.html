<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniFi Time Machine | Admin Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="text-center mb-0 text-primary-highlight">Unifi Time Machine</h1>
            <div class="text-end">
                <span class="text-secondary me-2">Welcome,</span>
                <span class="fw-bold">{{.User.Username}}</span>
                {{if .User.IsAdmin}}
                    <a href="/admin" class="ms-3 btn btn-outline-warning btn-sm">
                        <i class="fas fa-user-shield me-1"></i> Admin
                    </a>
                {{end}}
                <a href="/logout" class="ms-3 btn btn-outline-secondary btn-sm">
                    <i class="fas fa-sign-out-alt me-1"></i> Logout
                </a>
            </div>
        </div>
        <p class="text-center text-secondary">Dashboard Loaded At: {{.Now}}</p>
        <hr class="text-secondary">

        <!-- Info Cards Row -->
        <div class="row mb-4 justify-content-center">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-video me-2"></i>Video Status & Control</div>
                    <div class="card-body">
						{{if .User.IsAdmin}}
						<form method="POST" action="/force-generate">
                            <button type="submit" class="btn btn-primary btn-sm w-100 mb-2">
                                <i class="fas fa-play me-1"></i> Force Generate All
                            </button>
                        </form>
						{{end}}
                        <a href="/log" class="btn btn-info btn-sm w-100 mb-2" target="_blank">View FFmpeg Log</a>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-database me-2"></i>Storage Statistics</div>
                    <div class="card-body">
                        <p><strong>Total Images:</strong> {{.ImageStats.total_images}}</p>
                        <p><strong>Total Disk Usage:</strong> {{.ImageStats.image_size}}</p>
                        <p><strong>Last Snapshot:</strong> {{.ImageStats.last_image_time}}</p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-cogs me-2"></i>System Info</div>
                    <div class="card-body">
                        <p><strong>OS Type:</strong> {{.SystemInfo.os_type}}</p>
                        <p><strong>CPU Usage:</strong> <span id="cpu-usage">{{.SystemInfo.cpu_usage}}</span></p>
                        <p><strong>Memory Usage:</strong> <span id="memory-usage">{{.SystemInfo.memory_usage}}</span></p>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header"><i class="fas fa-camera me-2"></i>Camera Status</div>
                    <div class="card-body">
                        <p><strong>Name:</strong> {{.CameraStatus.Name}}</p>
                        <p><strong>Model:</strong> {{.CameraStatus.Model}}</p>
                        <p><strong>Status:</strong> 
                            {{if eq .CameraStatus.Connected "true"}}
                                <span class="badge status-badge-ok">{{.CameraStatus.Status}}</span>
                            {{else}}
                                <span class="badge status-error">{{.CameraStatus.Status}}</span>
                            {{end}}
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Timelapse Video Cards Row -->
        <div class="row justify-content-center">
            {{ $timelapseOrder := .TimelapseOrder }}
            {{ range $typeName := $timelapseOrder }}
                {{ with (index $.AvailableTimelapses $typeName) }}
                    {{ $videos := . }}
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card">
                            <div class="card-header"><i class="fas fa-film me-2"></i>{{ $typeName }} Timelapse</div>
                            <div class="card-body">
                                <video id="video-{{$typeName}}" controls class="w-100 rounded shadow mb-3" poster="/data/latest_snapshot.jpg" style="max-height: 400px;">
                                    <source id="source-{{$typeName}}" src="{{ (index $videos 0).Path }}" type="video/webm">
                                    <div class="alert alert-warning mt-3">Your browser does not support the video tag.</div>
                                </video>
                                <div class="d-flex justify-content-between">
                                    <div class="flex-grow-1 me-2">
                                        <select id="select-{{$typeName}}" class="form-select timelapse-select" data-video-target="video-{{$typeName}}" data-download-target="download-{{$typeName}}">
                                            {{ range $videos }}
                                                <option value="{{.Path}}">{{.Date}}</option>
                                            {{ end }}
                                        </select>
                                    </div>
                                    <a href="{{ (index $videos 0).Path }}" id="download-{{$typeName}}" class="btn btn-outline-success" download>
                                        <i class="fas fa-download"></i>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                {{ end }}
            {{ end }}
        </div>

        <!-- Gallery Card -->
        <div class="card">
            <div class="card-header"><i class="fas fa-images me-2"></i>24-Hour Daily Gallery</div>
            <div class="card-body">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-3">
                        <label for="date-select" class="form-label">Select Date:</label>
                        <select id="date-select" class="form-select"></select>
                    </div>
                    <div class="col-md-9 pt-4">
                        <p class="text-secondary" id="gallery-info">Displaying hourly snapshots for <span class="text-primary-highlight" id="current-gallery-date">{{.DefaultGalleryDate}}</span>.</p>
                    </div>
                </div>
                <div class="row row-cols-3 row-cols-md-6 row-cols-lg-12 g-2" id="gallery-grid"></div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Go variables passed to JS
        const availableDates = JSON.parse('{{js .AvailableDates}}');
        const defaultDate = "{{.DefaultGalleryDate}}";
        const initialGalleryData = JSON.parse('{{js .DefaultGalleryImages}}');
    </script>
    <script src="/static/js/main.js"></script>
</body>
</html>